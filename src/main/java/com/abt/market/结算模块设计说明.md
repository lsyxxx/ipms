# 结算需求说明
## 结算业务
结算包含2部分
1. 公司作为乙方结算
2. 公司作为甲方结算

## 目前问题
主要公司作为乙方结算：
1. 存在长期未结算项目而不知道，导致无法向甲方追款
2. 结算有时不是按一个个完整的项目结算，比如一个项目此次仅结算50个样品，剩余30个需等下次结算。这样对于处理结算业务的人要求明确知道哪些结算了，哪些没结算。

## 设计目的
1. 能统计出哪些结算了，哪些没结算
2. 业务人员上手简单

## 业务流程
1. 基础信息，结算公司，合同，附件等
2. 具体结算信息，有2种模式：  
   1. 按样品结算：具体到每个样品
   2. 按项目-检测项目结算：具体到项目-检测项目-单价，不需要具体到每个样品
3. 操作方式：  
   1. 按样品结算：系统内选择检测项目、样品，输入每个样品的单价，根据样品系统自动生成stlm_smry
   2. 按样品结算：导入样品excel，系统内自动生成stlm_smry
   3. 按项目结算：导入excel，没有stlm_test数据

## 如何统计
1. 根据sltm_smry统计
2. 统计要素：  
   1. 项目编号，项目是否全部结算
   2. 结算数量：实际和甲方确认的结算数量
   3. 样单数量/送样数量/检测数量
   4. 单价
   5. 总价

## 存在问题
1. 结算时可能不仅是室内检测费用，比如还有**取样费用**，这个费用并不体现在检测项目中，而且可能不是和样品关联。比如一个项目有50个样品，取样费是1次。但是这个费用需要体现在单个项目的结算中（实际的结算一般按单井结算，包含取样费用，单井每个检测项目的单价，合计等）


## 表设计
1. 结算主表：stlm_main：记录单次结算主要信息，如结算公司，合同，附件等
2. 结算汇总表：stlm_smry:
   1. 用于保存汇总数据，方便页面展示。有时结算样品会非常多（可能几千个），如果仅用前端/后端实时通过stlm_test计算汇总，可能会太慢了。
   2. 汇总数据表，维度：记录每个项目的每个检测项目的结算数量、单价、总价。是常用的结算方式
3. 结算样品表：stlm_test: 结算样品表，维度：记录每个结算样品，是最小的维度
4. 临时样品表：stlm_test_temp: 结构与stlm_test基本一样，是stlm_test的临时数据表。用于在未保存表单时上传样品
5. 临时汇总表: stlm_smry_temp: 是stlm_smry的临时表，用于在未保存表单时上传汇总数据。

## 一些说明
1. stlm_test表的原因   
   - 本来是想结算维度具体到每个样品，但是后面发现往往无法实现。因为在于甲方确认结算数量时，甲方确认结算的样品与我司提交报告（或样单）样品数量不一致。简单理解就是甲方认为部分样品数据不合适，这些样品我们实际是做检测了，只是甲方不结算。但是也不会告诉我司具体哪些样品要不认定。所以我方是无法知道具体哪个样品不结算（或者认为价格为0）。
   - 
2. 
